\documentclass[12pt,fleqn]{article}

\usepackage[utf8]{inputenc}
\usepackage[T2A]{fontenc}
\usepackage{amssymb,amsmath,mathrsfs,amsthm}
\usepackage[russian]{babel}
\usepackage{graphicx}
\usepackage[footnotesize]{caption2}
\usepackage{indentfirst}
%\usepackage[ruled,section]{algorithm}
%\usepackage[noend]{algorithmic}
%\usepackage[all]{xy}
%\usepackage{natbib}

% Параметры страницы
\textheight=23.5cm
\textwidth=16cm
\oddsidemargin=5mm
\evensidemargin=-5mm
\marginparwidth=36pt
\topmargin=-1cm
\footnotesep=3ex
%\flushbottom
\raggedbottom
\tolerance 3000
% подавить эффект "висячих стpок"
\clubpenalty=10000
\widowpenalty=10000
\renewcommand{\baselinestretch}{1.1}
\renewcommand{\baselinestretch}{1.5} %для печати с большим интервалом

\begin{document}

\begin{titlepage}
\begin{center}
\ \vspace{-2cm}

    \includegraphics[width=0.5\textwidth]{msu.pdf}\\
    {Московский государственный университет имени М.В.~Ломоносова}\\
    Факультет Вычислительной Математики и Кибернетики\\
    Кафедра Автоматизации Систем Вычислительных Комплексов
    
    \vspace{3cm}

    {\Large Щербаков~Александр~Станиславович}

	\vspace{1cm}    
    
    {\Large\bfseries Расчёт освещённости при помощи метода излучательности на графических процессорах для интерактивных приложений\\}

	\vspace{1cm}

    {\large ВЫПУСКНАЯ КВАЛИФИКАЦИОННАЯ РАБОТА}

\end{center}

\vfill

    \begin{flushright}
            \textbf{Научный руководитель:}\\
            к.ф-м.н. В. А. Фролов
    \end{flushright}

\vfill

\begin{center}
    Москва, 2017
\end{center}

\end{titlepage}

\newpage
\renewcommand{\contentsname}{Содержание}
\tableofcontents

\newpage
\begin{abstract}
    В данной работе предлагается новый подход к реализации метода излучательности с использованием специальных преобразований матрицы форм-факторов. Данные модификации позволяют сократить объём вычислений для нескольких отражений света от поверхностей 3D-сцены за счёт вычислений специальной матрицы форм-факторов и её последующего сжатия методом DXT. Сжатие позволяет получить ускорение вычислений за счёт поддержки аппаратной декомпрессии данных указаного формата. Описанная реализация в 10 раз быстрее и требует в 3 раза меньше памяти, чем классический метод излучательности, реализованный на видеокарте.
\end{abstract}

\newpage
\section{Введение}

Современные 3D-сцены составлены из сотен тысяч треугольников. Во многих приложениях использующих такие сцены возникает необходимость видеть сцену с различных ракурсов с динамическим изменением конфигурации освещения. Наибольшую сложность в таких случаях представляет вычисление вторичного освещения, то есть света, отражённого от поверхностей.

В настоящий момент разработано несколько методов вычисления глобального освещения сцены. Наиболее точным является алгоритм излучательности. В существующих решениях данный алгоритм выполняется на центральном процессоре и вычисленные значения освещения обновляются раз в 5-10 кадров. Выполнение данного алгоритма на видеокартах затруднено высокой вычислительной сложностью и требуемыми затратами памяти.

Предложенные оптимизации классического алгоритма излучательности позволяют увеличить скорость вычислений в 10 раз и уменьшить количество данных, с которыми ведётся работа, в 3 раза.

\pagebreak

\section{Постановка задачи}

\subsection{Неформальная постановка задачи}

Требуется уменьшить вычислительные затраты при расчёте вторичного освещения в~3D-сцене с~динамическими источниками света методом излучательности.

\subsection{Формальная постановка задачи}

Для заданной трёхмерной сцены (геометрия, источники света, материалы) первичным освещением называется освещение исходящее непосредственно из~источников света. Вторичным освещением называется освещение, полученное путём многократного отражения первичного освещения от~поверхностей сцены.

Необходимо, используя данные о~геометрии и~материалах сцены, провести её предобработку. Полученные данные используются во~время отрисовки сцены в~интерактивном режиме с~изменением конфигурации освещения.

Цель работы --- уменьшить время визуализации сцены и~необходимые ресурсы видеопамяти.

\pagebreak

\section{Обзор методов расчета вторичного освещения}

\subsection{Instant Radiosity}

Данный метод \cite{InstantRadiosity} является одним из~самых популярных методов расчёта вторичного освещения. Для визуализации каждого кадра выполняются следующие шаги:

\begin{enumerate}

\item На~источниках света выбираются точки.

\item Из~выбранных точек трассируются случайные лучи. Лучи отражаются столько раз, сколько отражений света необходимо учесть при визуализации.

\item Каждая из~точек полученных путей является вторичным источником света. Для них производится рендеринг с~целью определить, какие области сцены освещаются источником.

\item В~специальном буффере суммируется вклад вторичных источников света в~освещение каждого пикселя.

\item Полученные значения освещения используются для финальной визуализации.

\end{enumerate}

Развитием метода Instant Radiosity является алгоритм Reflective Shadow Maps \cite{ReflectiveShadowMaps}. Он отличается способом выбора вторичных источников света. Вместо трассировки происходит создание карты теней \cite{ShadowMaps} для источников света. По~карте теней выбираются вторичные источники как пиксели на~карте. Плотность выбора источников на карте теней и их вес увеличивается с расстоянием до центра карты.

\subsubsection{Достоинства метода}

\begin{enumerate}

\item Этот метод значительно меньших вычислительных затрат по сравнению с остальными современными методами.

\item Не требуется предобработка сцены.

\end{enumerate}

\subsubsection{Недостатки метода}

\begin{enumerate}

\item При недостаточном количестве вторичных источников света метод имеет низкую точность.

\item Требуемые вычисления существенно увеличивается с увеличением количества первичных и вторичных источников света.

\end{enumerate}

\subsection{Light Propagation Volumes}

Этот алгоритм \cite{LightPropagationVolumes} создаёт вторичные источники света так же, как это делается в Instance Radiosity, но расчёт вторичного освещения производится иначе:

\begin{enumerate}

\item На первом шаге создаются регулярная трёхмерная сетка для переноса света и сетка с упрощенным представлением сцены. На последующих итерациях алгоритма сетка с геометрией перестраивается при необходимости.

\item Вторичные источники света используются для инициализации освещения на сетке.

\item Производится перенос света по сетке. В этом процессе учитывается вторая сетка с упрощённой сценой для моделирования отражений.

\item Освещение попавшее на поверхности используется для визуализации финального изображения.

\end{enumerate}

\subsubsection{Достоинства метода}

\begin{enumerate}

\item Позволяет использовать различные эффекты связанные с полупрозрачностью среды.

\item Можно динамически изменять сцену.

\end{enumerate}

\subsubsection{Недостатки метода}

\begin{enumerate}

\item Артефакты связанные с дискретизацией пространства.

\item Недостаточное количество итераций переноса даёт некачественное изображение.

\item Сложность вычислений растёт кубически с увеличением точности сетки.

\end{enumerate}

\subsection{Voxel Cone Tracing}

В методе Voxel Cone Tracing \cite{VoxelConeTracing} производится сбор освещения падающего на пиксель путём трассировки конусов из этого пикселя. Общую схему алгоритма можно представить следующим образом:

\begin{enumerate}

\item Вначале, создаётся воксельная сетка, в которой хранятся несколько мип-уровней сцены. Для каждого нового кадра можно использовать уже созданную сетку, изменяя её при изменении сцены.

\item Производится расчёт освещения для каждого пикселя. Для этого производится трассировка нескольких конусов из пикселя в разных направлениях. Эти конусы собирают падающую освещённость в направлениях трассировки.

\end{enumerate}

При трассировке конусов происходит активное использование мип-уровней воксельной сетки. При удалении от пикселя данные берутся из мип-уровней с меньшей детадизацией.

\subsubsection{Достоинства метода}

\begin{enumerate}

\item Высокое качество изображения.

\item Поддержка многих материалов поверхностей.

\item Динамическое изменение сцены.

\end{enumerate}

\subsubsection{Недостатки метода}

\begin{enumerate}

\item Артефакты связанные с воксельным приближением сцены.

\item Высокие требования видеопамяти.

\item Большая сложность вычислений.

\end{enumerate}

\subsection{Spherical Harmonics}

Техника сферических гармоник \cite{SphericalHarmonics} основывается на разложении сложных функций освещенности в сумму более простых для вычисления величин. Изначально такое разложение использовалось в физике для моделирования конфигурации электрона в атоме. Сложная сферическая функция раскладывается по ортонормированному базису. Это один из вариантов трёхмерного разложения функции в ряд Фурье.

Для некоторых точек считаются коэффециенты разложения их функций освещения по базису. При визуализации сферические функции освещения из источников также раскладываются по базису. В итоге вычисление освещения в точке с разложенной в ней функцией освещенности сводится к скалярному произведению векторов состоящих из коэффициентов функции освещённости в данной точке и функции освещения из источника.

\subsubsection{Достоинства метода}

\begin{enumerate}

\item Небольшое количество вычислений при визуализации.

\end{enumerate}

\subsubsection{Недостатки метода}

\begin{enumerate}

\item Для сложных сцен и конфигураций освещения может потребоваться много коэффицентов в разложении функций. Это увеличивает количество необходимых вычислений и количество требуемой памяти.

\item Артефакты связанные с интерполяцией освещения между точками в которых известно разложение функции.

\end{enumerate}

\subsection{Radiosity}

Метод излучательности (Radiosity) \cite{Radiosity, Radiosity2, Radiosity3, GPURadiosity} позволяет получать наиболее качественные изображения по сравнению с остальными методами. Однако, время выполнения и требуемые ресурсы очень сильно зависят от сцены. На сценах содержащих сотни тысяч или даже миллионы треугольников он непременим. Поэтому на практике алгоритм излучательности выполняется для упрощённой сцены (содержащей меньшее количество площадок) и результат расчёта переносится на исходную сцену \cite{Simplification}.

Одна из наиболее комерчески успешных реализаций этого алгоритма используется в графическом движке "Enlighten" \cite{Enlighten}. В нём расчёты производятся на центральном процессоре. В виду большого количества вычислений, которые выполняются на процессоре помимо вычисления вторичного освещения, нет возможности обновлять вторичное освещение для каждого кадра. Поэтому посчитанное вторичное освещение используется для следующих 5-10 кадров. В этом движке для сцены нужна её версия упрощённая вручную.

Алгоритм излучательности требует предобработки сцены:

\begin{enumerate}

\item Для сцены происходит её разбиение сцены на площадки (при создании упрощённого аналога вручную также может быть создано разбиение).

\item Считаются форм-факторы для каждой пары площадок.

\end{enumerate}

Форм-фактор --- это число показывающее для пары площадок какая часть энергии пришедшей на первую площадку отразится на вторую.

Для визуализации используются предпосчитанные значения форм-факторов и для каждого кадра выполняется расчёт вторичного освещение методом излучательности:

\begin{enumerate}

\item Вычисляется, либо задаётся значение для начальной светимости площадок. Из этих значений получается вектор начальной светимости.

\item Вектор начальной светимости умножается на матрицу форм-факторов. Таким образом получается вектор освещения пришедшего на площадки.

\item При умножении значений пришедшего освещения на цвета площадок получается вектор светимости после первого отражения.

\item 2 и 3 шаги повторяются на векторов отраженного освещения несколько раз. На каждом шаге накапливается освещение пришедшее на площадку после каждого отражения.

\item Накопленное вторичное освещение отображется на исходной сцене.

\end{enumerate}

\subsubsection{Достоинства метода}

\begin{enumerate}

\item Наиболее близкое к точным методам изображение.

\item Высокая скорость вычислений для небольшого количества площадок.

\end{enumerate}

\subsubsection{Недостатки метода}

\begin{enumerate}

\item Квадратичных рост сложности вычислений и затрат видеопамяти при увеличении количества площадок.

\item Возможны артефакты при некачественном упрощенном аналоге сцены.

\end{enumerate}

\pagebreak

\section{Предложенные оптимизации}

В данном разделе описаны разработанные оптимизации алгоритма излучательности, позволяющие значительно сократить время выполнения алгоритма и количество требуемой памяти для хранения предподсчитанной матрицы форм-факторов.

\subsection{Учёт нескольких отражений в матрице форм-факторов}

Первая оптимизация заключается в преобразовании матрицы форм-факторов таким образом, чтобы она учитывала освещение полученное в ходе нескольких отражений.

Пусть сцена содержит $n$ площадок, для которых выполняется алгоритм излучательности. Введём необходимые обозначения:

$F$ --- матрица форм-факторов. Имеет размер $n \times n$.

$colors$ --- вектор размера $n$, содержащий цвета площадок в формате RGB. Таким образом, каждый элемент вектора $colors$ --- это трёхкомпонентный вектор, содержащий интенсивность цвета по каждому каналу.

$emission$ --- вектор значений начальной светимости площадок. Имеет размер $n$. Элементы этого вектора --- трёхкомпонентные векторы.

$excident^{(j)}$ --- вектор, структура которого аналогична предыдущим. Его элементами является освещение, полученное путём отражения пришедшего света на $j$-ой итерации алгоритма.

$incident^{(j)}$ --- вектор, той же структуры. Элементы вектора - освещение пришедшее на площадки после $j$-го отражения.

Обозначим $incident^{(0)} = emission$, чтобы можно было выписать формулы пересчёта освещения в более общем виде.

Таким образом, получается система уравнений:
\begin{equation}
\label{eq1}
incident^{(0)} = emission,
\end{equation}
\begin{equation}
\label{eq2}
excident^{(j)} = F \cdot incident^{(j)},
\end{equation}
\begin{equation}
\label{eq3}
incident^{(j + 1)} = colors \circ excident^{(j)},
\end{equation}

где $\circ$ --- почленное произведение (произведение Адамара).

Итоговое вторичное освещение после $k$ отражений будет равно
$\sum\limits_{h = 1}^k incident^{(h)}$.
Значение $incident^{(0)}$ не включено в сумму, так как оно представляет собой первичное освещение.

Введём "цветную" матрицу форм-факторов $F^C$, которая будет показывать количество освещения отражённое площадками по каждому цветовому каналу:
\begin{equation}
\label{eq4}
F^C_{ij} = F_{ij} * colors_i
\end{equation}

Используя уравнения (\ref{eq2}), (\ref{eq3}) и (\ref{eq4}) получим формулу для пересчёта векторов $incident$ на разных итерациях:
\begin{equation}
\label{eq5}
incident^{(j + 1)} = F^C \cdot incident^{(j)} = \left( F^C \right) ^ {(j + 1)} \cdot incident^{(0)}
\end{equation}

Теперь можно переписать итоговое вторичное освещение после $k$ итерации:
\begin{equation}
\label{eq6}
\sum\limits_{h = 1}^k incident^{(h)} = \sum\limits_{h = 1}^k \left(F^C\right)^h \cdot incident^{(0)}
\end{equation}

Как видно из правой части уравнения (\ref{eq6}), вектор $incident^{(0)}$ можно вынести за скобки. Тогда, вычисление вторичного освещения сведётся к вычислению полинома матрицы $F^C$ и умножению его на вектор $incident^{(0)}$:
\begin{equation}
\label{eq7}
\sum\limits_{h = 1}^k \left(F^C\right)^h \cdot incident^{(0)} = \left(\sum\limits_{h = 1}^k \left(F^C\right)^h\right) \cdot incident^{(0)}
\end{equation}

Выражение $F^{k-reflections} = \sum\limits_{h = 1}^k \left(F^C\right)^h$ не зависит от первичного освещения сцены и, следовательно, может быть вычисленно на этапе предподсчёта.

Таким образом, первая оптимизация заключается в вычислении значения $F^{k-reflections}$ на стадии предобработки сцены. При этом количество необходимых операций для расчёта вторичного освещения становится в $k$ раз меньше. Стоит также отметить, что размер матрицы форм-факторов увеличился в 3 раза, так как теперь она хранит значения для каждого цветового канала.

\subsection{DXT-сжатие матрицы форм-факторов}

Вторая предлагаемая оптимизация направлена на уменьшение количества памяти, необходимого для хранения матрицы форм-факторов, и уменьшения обращений к памяти при выполнении алгоритма. Так как данные хранятся в глобальной памяти видеокарты - памяти с наибольшей латентностью, уменьшение размера данных приведёт к росту производительности.

\begin{figure}[htb]
    \centering
    \includegraphics[]{1.pdf}
    \caption{Распределение значений в матрице форм-факторов на тестовой сцене (логарифмическая и линейная шкалы).}
    \label{init_distribution}
\end{figure}

Из рисунка \ref{init_distribution} видно, что большая часть значений не превосходит пороговой величины 0.005. Немногочисленные значения превышающий этот порог вносят больший вклад, поэтому их изменение, которое может произойти во время сжатия повлечёт за собой существенное ухудшение качества изображения. В связи с этим, значения матрицы форм-факторов делятся на две части. В первую входят значения которые относятся к 4\% маскимальных, во вторую - все остальные.

Значение 4\% было выбрано в ходе экспериментов, как величина при которой ошибка сжатия не велика, но при этом размер файла минимален (рис. \ref{part_error}).

\begin{figure}[htb]
    \centering
    \includegraphics[]{27.png}
    \caption{Потери при сжатии при различном количестве несжатых чисел.}
    \label{part_error}
\end{figure}

После того, как первая часть значений матрицы сохраняется отдельно, в матрице эти значения заполняются нулями. Так как оставшиеся значения вносят меньший вклад в результат вторичного освещения, то их можно сжать с потерями, при этом качество изображения уменьшится незначительно.

Для того чтобы сохранить матрицу в текстуру нужно привести все значения к промежутку от 0 до 255, но так как оставшиеся значения отличаются на несколько порядков, то требуется провести ряд преобразований над элементами матрицы. Сначала значения матрицы приводятся к промежутку от 0 до 1 (проводится деление значений на максимальное число из оставшихся). Далее производится логарифмирование значений матрицы. Распределение значений после этой операции показано на рисунке \ref{log_distribution}.

\begin{figure}[htb]
    \centering
    \includegraphics[]{2.pdf}
    \caption{Распределение значений матрицы форм-факторов после логарифмирования.}
    \label{log_distribution}
\end{figure}

Далее, к числам прибавляется константа 25, чтобы привести их на положительную полуось и происходит их масштабирование на промежуток от 0 до 255. Полученное распределение изображено на рисунке \ref{result_distribution}.

\begin{figure}[htb]
    \centering
    \includegraphics[]{3.pdf}
    \caption{Распределение значений матрицы форм-факторов после преобразований.}
    \label{result_distribution}
\end{figure}

После этих преобразований матрица может быть сохранена в текстуру (Рис. \ref{ff_matrix}).

\pagebreak

\begin{figure}[htb]
    \centering
    \includegraphics[]{4.png}
    \caption{Матрица форм-факторов.}
    \label{ff_matrix}
\end{figure}

Сжатие DXT-1 происходит по следующей схеме:

\begin{enumerate}

\item Изображение разбивается на блоки по $4\times4$ пикселей;

\item В каждом блоке выбираются два крайних цвета, такие чтобы цвет пикселей в блоке был между этими двумя цветами;

\item Крайние цвета кодируются 16 битами. 5 бит для красного цвета, 6 для зелёноего и 5 для синего;

\item Пиксели блока кодируются 2 битами каждый.

\end{enumerate}

Из-за неоднородности распределения чисел в матрице форм-факторов при сжатии могут наблюдаться значительные потери. Чтобы их уменьшить проводится реорганизация матрицы. Строки и столбцы матрицы переставляются местами так, чтобы похожие значения были рядом. Чтобы сохранить свойства матрицы, позволяющие ей быть использованной для корректного расчёта освещения при перестановке $i$-ой и $j$-ой строк, необходимо также поменять местами $i$-ый и $j$-ый столбцы (рис. \ref{reorder_scheme}).

\begin{figure}[htb]
    \centering
    \includegraphics[width=\linewidth]{8.png}
    \caption{Схема реорганизации матрицы форм-факторов.}
    \label{reorder_scheme}
\end{figure}

В качестве метрики похожести строк (аналогично столбцов) была выбрана сумма расстояний между координатами векторов. Введём полный граф. Его вершинами будут строки матрицы. Длины рёбер --- метрика похожести строк. Таким образом, задача о нахождении оптимального расположения строк в матрице сводится к задаче комивояжёра. Эта задача из класса NP и к точному решению можно прийти только путём перебора. Поэтому был выбран эвристический жадный алгоритм реорганизации матрицы.

Алгоритм осуществляется в два прохода. В первом метрика вычисляется для строк, во втором --- для столбцов.

В одном проходе осуществляется итерирование по всем строкам (столбцам), в ходе которого:

\begin{itemize}

\item Вычисляется метрика похожести для текущей строки и всех строк, которые расположены ниже (правее, в случае столбцов).

\item Наиболее близкая по метрике строка ставится после текущей. Алгоритм будет обрабатывать её следующей.

\end{itemize}

На рисунках \ref{reorder_1} и \ref{reorder_2} показаны матрицы форм-факторов после первого и второго проходов алгоритма реорганизации.

\begin{figure}[htb]
    \centering
    \includegraphics[]{5.png}
    \caption{Матрица форм-фаторов после одного прохода реорганизации.}
    \label{reorder_1}
\end{figure}

\pagebreak

\begin{figure}[htb]
    \centering
    \includegraphics[]{6.png}
    \caption{Матрица форм-факторов после реорганизации.}
    \label{reorder_2}
\end{figure}

\pagebreak

Потери при сжатии при реорганизации матрицы снижаются. Как видно из таблицы приведённой ниже их удалось уменьшить в 5 раз.

\begin{center}

\begin{tabular}{|p{0.2\columnwidth}|p{0.25\columnwidth}|p{0.25\columnwidth}|p{0.25\columnwidth}|}

\hline
~ & Матрица без реорганизации & После одного прохода алгоритма & После двух проходов алгоритма \\ \hline
Средняя ошибка & 1,28E-06 & 8,13E-07 & 5,88E-07 \\ \hline
Макс. ошибка & 0,4622 & 0,4684 & 0,1524 \\ \hline
Сумм. ошибка & 47,12 & 18,86 & 9,40 \\ \hline

\end{tabular}

\end{center}

После изменения матрицы, она сохраняется как текстура с DXT-сжатием, данная текстура показана на рисунке \ref{ff_texture}. Визуально сложно найти отличия от матрицы без сжатия, поэтому ниже также приведены разница между сжатой и несжатой матрицами по красному каналу изображения (рис. \ref{red_comparison}) и по всем каналам (рис. \ref{rgb_comparison}). Разница по зелёному и синему каналам имеет схожую структуру.

\begin{figure}[htb]
    \centering
    \includegraphics[]{7.png}
    \caption{Текстура, содержащая матрицу форм-факторов.}
    \label{ff_texture}
\end{figure}

\begin{figure}[htb]
    \centering
    \includegraphics[]{9.pdf}
    \caption{Изменение красного канала матрицы форм-факторов, после сжатия.}
    \label{red_comparison}
\end{figure}

\begin{figure}[htb]
    \centering
    \includegraphics[width=\linewidth]{17.pdf}
    \caption{Изменение матрицы форм-факторов, после сжатия.}
    \label{rgb_comparison}
\end{figure}

\pagebreak

\section{Описание практической части}

Реализация алгоритма излучательности и предложенные оптимизации была выполнена на языке GLSL с использованием фреймворка OpenGL. Предподсчёт выполняется на видеокарте с использованием программ на OpenCL. 

Так как современные 3D-сцены содержат сотни тысяч треугольников и выполнение алгоритма излучательности является непреемлемым для таких порядков элементов сцены, для вычисления вторичного освещения была выбрана упрощённая версия той же самой сцены.

Стадия предобработки сцены описывается следующими шагами:

\begin{enumerate}

\item Автоматическое упрощение исходной сцены с использованием вокселизации.

\item Вычисление форм-факторов для площадок сцены.

\item Преведение матрицы форм-факторов к виду, в котором содержится информация о переносе освещения по каждой компоненте.

\item Вычисление полинома матрицы форм-факторов, учитывающего несколько отражений.

\item Перестановка строк и столбцов матрицы

\item Сохранение матрицы форм-факторов с использованием DXT-сжатия.

\end{enumerate}

После генерации этих данных, они используются для отрисовки сцены в интерактивном режиме с динамическим освещением.

\begin{enumerate}

\item Создаются карты теней для источников света.

\item Для каждой площадки упрощённой сцены вычисляется её освещенность при помощи карт теней.

\item Вектор начальной освещённости умножается на матрицу форм-факторов, хранящуюся в сжатой текстуре.

\item Учитываются значения матрицы форм-факторов, которые хранятся отдельно для увеличения качества.

\item Посчитанное вторичное освещение для упрощенной сцены переносится на исходную сцену.

\item На экран выводится финальное изображение с учётом первичного и вторичного освещения.

\end{enumerate}

В ходе работы были проведены сравнения с классической реализацией алгоритма излучательности, методом трассировки путей и реализацией алгоритма Light Propagation Volumes из движка Unreal Engine 4. Сравнение проводилось на архитектурной сцене, содержащей 66450 треугольников. Матриалы всех поверхностей сцены диффузные. Использовался направленный динамичный источник света.

\subsection{Сравнение требуемого объёма памяти}

На рисунке \ref{size_comparison} показано, что применение первой описанной оптимизации увеличивает количество данных в 3 раза, но применение DXT-сжатия позволяет уменьшить размер файлов в 3 раза по сравнению с исходными.

\begin{figure}[htb]
    \centering
    \includegraphics[width=\linewidth]{23.png}
    \caption{Сравнение размера файлов форм-факторов.}
    \label{size_comparison}
\end{figure}

\subsection{Сравнение времени выполнения}

Применение каждой из предложенных оптимизаций даёт существенный прирост в скорости выполнения. Первая оптимизация для трёх отражений ускоряет адгоритм в 3 раза. Вторая --- в 10 раз быстрее чем классическая реализация алгоритма излучательности (рис. \ref{speed_comparison}).

\begin{figure}[htb]
    \centering
    \includegraphics[width=\linewidth]{24.png}
    \caption{Сравнение времени выполнения алгоритма.}
    \label{speed_comparison}
\end{figure}

%\pagebreak

\subsection{Сравнение качества изображения}

На рисунке \ref{image_comparison} представлено сравнение с методами Light Propagation Volumes, трассировки путей и классической излучательности. Метод трассировки путей, как физически корректный был выбран в качестве эталона. Видно, что изображения полученные матодом излучателньости, в том числе и с оптимизациями, ближе к эталонному, чем изображение сгенерированное Light Propagation Volumes. 

Размер сетки для алгоритма LPV был выбран такой, чтобы частота генерации изображения совпадала с частотой работы предложенного модифицированного алгоритма излучательности. Таким образом, оба изображения получены при частоте 40 FPS.

\pagebreak

\begin{figure}[htb]
    \centering
    \includegraphics[width=\linewidth]{26.png}
    \caption{Сравнение полученных изображений.}
    \label{image_comparison}
\end{figure}

Части сцены, на которых заметно, что метод излучательности показывает лучший результат, чем Light Propagation Volumes представлены на рисунках \ref{image_comparison2} и \ref{image_comparison3}.

Предложенные оптимизации алгортма излучательности позволяют получать изображение, аналогичное полученному методу трассировки путей, за более короткое время. Методу трассировки путей потребовалось более 5 минут, для создания изображения. Реализации предложенного метода - 17 милисекунд.

\pagebreak

\begin{figure}[htb]
    \centering
    \includegraphics[scale=0.5]{28.png}
    \caption{Сравнение полученных изображений.}
    \label{image_comparison2}
\end{figure}

\begin{figure}[htb]
    \centering
    \includegraphics[scale=0.5]{29.png}
    \caption{Сравнение полученных изображений.}
    \label{image_comparison3}
\end{figure}

Предложенные оптимизации могут быть использованы с другими распространёнными оптимизациями алгоритма излучательности, например иерархической излучательностью. При этом качество изображения может быть улучшено за счёт увеличения количества площадок, для которых выполняется алгоритм, а следовательно и уменьшением ошибки приближения сцены воксельной моделью.

\pagebreak

\section{Заключение}

В ходе работы были разработаны и реализованы оптимизации для оригинального алгоритма излучательности. 

Первая из них позволяет ускорить алгоритм излучательности учитывающий $k$ отражений света в $k$ раз. Для случая 3 отражений приведены данные измерений на рисунке \ref{speed_comparison}. Данная оптимизация увеличивает требуемый объём памяти для выполнения алгоритма в 3 раза.

Вторая модернизация классического алгоритма излучательности позволила уменьшить требуемый объем данных в 3 раза по сравнению с исходным. При этом время вычислений уменьшилось в 10 раз относительно первоначального.

Предложенные оптимизации позволяют вычислять вторичное освещение на 3D-сценах в реальном времени с высокой точностью.

\newpage
\renewcommand{\bibname}{Список литературы}
\addcontentsline{toc}{section}{\bibname}


%\def\BibUrl#1.{}\def\BibAnnote#1.{}
%\def\BibUrl#1{\\{\footnotesize\tt\def~{\char126} http://#1}}

\bibliographystyle{utf8gost71u}
\bibliography{references}

\end{document}
